    <html>
      <head>
        <script type="text/javascript" src="http://brown-ros-pkg.googlecode.com/svn/tags/brown-ros-pkg/rosbridge/ros.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      </head>
    <body onload="main()">
<FORM>
<script type="text/javascript">


  var mode = "TURN";

  function validateRadio(obj){
    //var image = document.getElementById("pointer_div");
    if (document.getElementById("turn").checked) {
      //image.style.backgroundImage = 'url(turn_arrows.jpg)'; 
      mode = "TURN";
    } else if (document.getElementById("strafe").checked) {
      //image.style.backgroundImage = 'url(strafe_arrows.jpg)';//;width:370px;height:376px;";
      mode = "STRAFE";
    } 

  }

  function main() {

    var appmanager_started = false;
    var available_apps;
    var message;
    var newInterval;
    var returned = true;
    var robot = "";
    var running_apps;
    var serv_returned = true;
    var skipEvict = false;
    var skipStart = false;
    var user;
    var xmlHttpReq;
    var x = 0;
    var y = 0;
    var z = 0;
    var IN_USE = 0;
    var OFF = 1;
    var VALID = 2;

    var url_array = window.location.href.split('/');
    var url = "http://" + url_array[2] + "/cgi-bin/control.py?action=GET_STATE";

    var connection = new ros.Connection("ws://" + url_array[2] + ":9091");
    xmlHttpReq = CreateXmlHttpReq(function () {});
      if (xmlHttpReq) {
        XmlHttpGET(xmlHttpReq,"http://" + url_array[2] + "/cgi-bin/control.py");
      }
      connection.setOnOpen(function (e) {
 
        connection.callService('/rosjs/get_param','["/robot/name"]',function(msg) {
          robot = msg;

          xmlHttpReq = CreateXmlHttpReq(resultHandler);
          if (xmlHttpReq) {
            XmlHttpGET(xmlHttpReq, url);
          } else {
            alert("An error occured while attempting to process your request.");
          }
  
        });

      });

      function startApp() {
        if (serv_returned) {
          serv_returned = false;
          connection.callService('/rosjs/services','[]',function(arr) {
            for(var i=0;i<arr.length;i++){
              if (arr[i].trim() == "/" + robot + "/list_apps") {
                clearInterval(newInterval);
                connection.callService('/' + robot + '/list_apps','[]',function (arr) {
                  running_apps = arr.running_apps;
                  available_apps = arr.available_apps;
                  for (var k=0;k<running_apps.length;k++) {
                    if (running_apps[k].name == "pr2_teleop_app/pr2_teleop") {
                      returned = true;
                      connection.callService('/rosjs/services','[]',function(arr) {
                        for(var i=0;i<arr.length;i++){
                          if (arr[i].trim() == "/mjpeg_server/get_loggers") {
                            document.getElementById("app_elements").style.display = 'block';
                            document.getElementById("video_stream").src = "http://" + url_array[2] + ":8181/stream?topic=/wide_stereo/left/image_color";
                            return;
                          }
                        }
                      });
                    }
                  }  
                  connection.callService('/' + robot + '/start_app', "[\"pr2_teleop_app/pr2_teleop\"]",function(resp) {
                    alert("App started!")
                    connection.callService('/rosjs/services','[]',function(arr) {
                      for(var i=0;i<arr.length;i++){
                        if (arr[i].trim() == "/mjpeg_server/get_loggers") {
                          document.getElementById("app_elements").style.display = 'block';
                          document.getElementById("video_stream").src = "http://" + url_array[2] + ":8181/stream?topic=/wide_stereo/left/image_color";
                          return;
                        }
                      }
                    });
                  });
     
                  returned = true;
                });
              } 
              serv_returned = true;
            }
          });
        }
      }



      function resultHandler () {
        // request is 'ready'
        if (xmlHttpReq.readyState == 4) {
          // success
          if (xmlHttpReq.status == 200) {
            var tags = xmlHttpReq.responseText.split(/\r\n|\r|\n/);
            for(var i=0;i<tags.length;i++){
              if (tags[i] == "STATE_IN_USE") {
                state = IN_USE;
              }
              if (tags[i] == "STATE_VALID") {
                state = VALID;
                skipStart = false;
                skipEvict = false;
                //Show regular screen
                newInterval = setInterval(startApp,1000);
              }
              if (tags[i] == "STATE_OFF") {
                state = OFF;
                skipEvict = false;
                xmlHttpReq = CreateXmlHttpReq(startResultHandler);

                if (xmlHttpReq && !skipStart) {
                  XmlHttpGET(xmlHttpReq, "http://" + url_array[2] + "/cgi-bin/control.py?action=START_ROBOT");
                }

              }
              var splitLine = tags[i].split(" ");
              if (splitLine.length  > 1) {
                for(var j=0;j<splitLine.length;j++){
                  if (splitLine[j] == "USER:") {
                    if (!skipEvict) {
                      user = splitLine[j+1];
                      var evict = confirm("In use by: " + user +"\nWould you like to evict this user?");
                      if (evict) {
                        skipEvict = true;
                        xmlHttpReq = CreateXmlHttpReq(resultHandler);
                          if (xmlHttpReq) {
                            XmlHttpGET(xmlHttpReq, "http://" + url_array[2] + "/cgi-bin/control.py?action=STOP_ROBOT");
                                      
                          } 
                      } 
                    }
                    xmlHttpReq = CreateXmlHttpReq(resultHandler);
                    var m = 0;
                    while (state != OFF && state != VALID && m < 30) {
                      var t=setTimeout(function () {
                        XmlHttpGET(xmlHttpReq,"http://" + url_array[2] + "/cgi-bin/control.py?action=GET_STATE"); 
                      },1000);
                       m++;
                    }      
 
                  }
                  if (splitLine[j] == "MESSAGE:") {
                    message = splitLine[j+1];
                  }
                }  
              }
            }
          }
                        
        } else {
        }
          
      }



      function startResultHandler () {
      // request is 'ready'
        if (xmlHttpReq.readyState == 4) {
              // success
              //alert("Ready!");
              if (xmlHttpReq.status == 200) {
                //alert("200 Okay!"); 
                var k = 0;
                if (xmlHttpReq) {
                  xmlHttpReq = CreateXmlHttpReq(resultHandler);
                  skipStart = true;
                  while (state != VALID && k < 30) {
                    var t=setTimeout( function () {
                    XmlHttpGET(xmlHttpReq,"http://" + url_array[2] + "/cgi-bin/control.py?action=GET_STATE");
                    },1000);
                    k++;
                  }
                } else {
                      alert("An error occured while attempting to process your request.");
                } 
              }
        }
      } 
                    
        


      function CreateXmlHttpReq(handler) {
        var xmlhttp = null;

        if (window.XMLHttpRequest) {
          xmlhttp = new XMLHttpRequest();
        } else if (window.ActiveXObject) {
          // users with activeX off
          try {
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
          } catch (e) {}
        }

        if (xmlhttp) xmlhttp.onreadystatechange = handler;

        return xmlhttp;
        }    

        // XMLHttp send GEt request
      function XmlHttpGET(xmlhttp, url) {
        try {
          xmlhttp.open("GET", url, true); 
          xmlhttp.send(null);
        } catch (e) {}
      }

      function handleKey(code, down) {
        var scale = 0;
        if (down == true) {
          scale = 1;
        }
        switch (code) {
          case 37:
            //left
            if (mode == "TURN") {
              z = 1 * scale;
            } else if (mode == "STRAFE") {
              y = .5 * scale;
            }
            break;
          case 38:
            //up
            x = .5 * scale;
            break;
          case 39:
            //right 
            if (mode == "TURN") {
              z = -1 * scale;
            } else if (mode == "STRAFE") {
              y = -.5 * scale;
            }
            break;
          case 40:
            //down
            x = -.5 * scale;
            break;
        }
          pub();
      }
      function pub() {
        if (mode == "TURN") {
          connection.publish('/base_controller/command', 'geometry_msgs/Twist', '{"linear":{"x":' + x + ',"y":0,"z":0}, "angular":{"x":0,"y":0,"z":' + z + '}}');
        } else if (mode == "STRAFE") {
          connection.publish('/base_controller/command', 'geometry_msgs/Twist', '{"linear":{"x":' + x + ',"y":' + y + ',"z":0}, "angular":{"x":0,"y":0,"z":0}}');
        }
      }  

      document.addEventListener('keydown', function (e) {
        handleKey(e.keyCode, true);
      }, true);
      document.addEventListener('keyup', function (e) {
        handleKey(e.keyCode, false);
      }, true);
          

      connection.setOnClose(function (e) {
        alert("Connection closed.");
        xmlHttpReq = CreateXmlHttpReq(function () {});
        if (xmlHttpReq) {
          XmlHttpGET(xmlHttpReq,"http://" + url_array[2] + "/cgi-bin/control.py");
        }
        window.location.reload();
      });
      connection.setOnError(function (e) {
        alert("Error!");
      });



      document.getElementById("turn").checked=true;

    }
        </script>
<div id="app_elements" style="display: none;">
<img id="video_stream" alt="real-time video feed" />
<div style="float: right;">
<input type="radio" name="a" value="turn" id="turn"  onclick="validateRadio(this)"> Turn </br>
<input type="radio" name="a" value="strafe" id="strafe"  onclick="validateRadio(this)"> Strafe </br>

<div id="pointer_div" style = "background-image:url('turn_arrows.jpg');width:370px;height:376px;"/>
<p>Use the arrow keys on the keyboard to drive the turtlebot.</p>
<img border="0" src="keyboard-arrows.png" alt="Pulpit rock" width="300" height="206" />
</div>
</div>
</FORM>
    </body>
    </html>
